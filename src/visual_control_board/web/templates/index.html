<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title | default("Visual Control Board") }}</title>
    <!-- Link to the main stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <!-- FontAwesome for icons (optional, used if button.icon_class is set) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- HTMX library -->
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <!-- Display current page name or default title -->
        <h1>{{ current_page.name if current_page else page_title | default("Control Board") }}</h1>
    </header>

    <!-- Area for update notifications -->
    <div id="update-notification-area" class="update-notification-container">
        {# The partials/update_banner.html will be rendered here by API calls or on initial load #}
        {% include "partials/update_banner.html" with context %}
    </div>

    <main class="container">
        {% if error %}
            <!-- Display an error message if passed from the route -->
            <div class="error-message">{{ error }}</div>
        {% elif current_page and current_page.buttons %}
            <!-- Main button grid area -->
            <div 
                class="button-grid" 
                {% if current_page.layout == 'grid' and current_page.grid_columns %}
                    style="grid-template-columns: repeat({{ current_page.grid_columns }}, 1fr);"
                {% endif %}
            >
                {# Loop through buttons for the current page and include the button partial #}
                {% for button in current_page.buttons %}
                    {% with button=button, request=request %} {# Pass button and request context to the partial #}
                        {% include "partials/button.html" %}
                    {% endwith %}
                {% endfor %}
            </div>
        {% elif current_page %}
             <!-- Message if the current page has no buttons configured -->
             <p>No buttons configured for page: '{{ current_page.name }}'.</p>
             <p>Please check your <code>ui_config.yaml</code>.</p>
        {% else %}
            <!-- Fallback message if no page or buttons are available -->
            <p>No page or buttons configured to display.</p>
            <p>Please ensure your <code>ui_config.yaml</code> is correctly set up.
            The application looks for configurations in <code>user_config/</code> at the project root first,
            then falls back to <code>config_examples/</code>. Check server logs for more details if issues persist.
            </p>
        {% endif %}
    </main>

    <footer>
        <p>Visual Control Board</p>
        <div id="toast-container">
            <div id="toast-message"></div>
        </div>
    </footer>

    <script>
        document.body.addEventListener('htmx:afterSwap', function(event) {
            const toastElement = document.getElementById('toast-message'); 
            if (toastElement && toastElement.classList.contains('show') && toastElement.textContent.trim() !== '') {
                setTimeout(() => {
                    toastElement.classList.remove('show'); 
                    setTimeout(() => {
                        const currentToast = document.getElementById('toast-message');
                        if (currentToast === toastElement && !currentToast.classList.contains('show')) {
                            currentToast.innerHTML = ''; 
                            currentToast.classList.remove('error'); 
                        }
                    }, 500); 
                }, 3000); 
            }
        });
    </script>
</body>
</html>
