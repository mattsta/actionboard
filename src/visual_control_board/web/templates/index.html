<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title | default("Visual Control Board") }}</title>
    <!-- Link to the main stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <!-- FontAwesome for icons (optional, used if button.icon_class is set) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- HTMX library -->
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <!-- Display current page name or default title -->
        <h1>{{ current_page.name if current_page else page_title | default("Control Board") }}</h1>
    </header>

    <!-- Area for update notifications -->
    <div id="update-notification-area" class="update-notification-container">
        {# The partials/update_banner.html will be rendered here by API calls or on initial load #}
        {% include "partials/update_banner.html" with context %}
    </div>

    <main class="container">
        {% if error %}
            <!-- Display an error message if passed from the route -->
            <div class="error-message">{{ error }}</div>
        {% elif current_page and current_page.buttons %}
            <!-- Main button grid area -->
            <div 
                class="button-grid" 
                {% if current_page.layout == 'grid' and current_page.grid_columns %}
                    style="grid-template-columns: repeat({{ current_page.grid_columns }}, 1fr);"
                {% endif %}
            >
                {# Loop through buttons for the current page and include the button partial #}
                {% for button in current_page.buttons %}
                    {% with button=button, request=request %} {# Pass button and request context to the partial #}
                        {% include "partials/button.html" %}
                    {% endwith %}
                {% endfor %}
            </div>
        {% elif current_page %}
             <!-- Message if the current page has no buttons configured -->
             <p>No buttons configured for page: '{{ current_page.name }}'.</p>
             <p>Please check your <code>ui_config.yaml</code>.</p>
        {% else %}
            <!-- Fallback message if no page or buttons are available -->
            <p>No page or buttons configured to display.</p>
            <p>Please ensure your <code>ui_config.yaml</code> is correctly set up.
            The application looks for configurations in <code>user_config/</code> at the project root first,
            then falls back to <code>config_examples/</code>. Check server logs for more details if issues persist.
            </p>
        {% endif %}
    </main>

    <footer>
        <p>Visual Control Board</p>
        <div id="toast-container">
            <div id="toast-message"></div>
        </div>
    </footer>

    <script>
        // Toast message handling
        document.body.addEventListener('htmx:afterSwap', function(event) {
            const toastElement = document.getElementById('toast-message'); 
            if (toastElement && toastElement.classList.contains('show') && toastElement.textContent.trim() !== '') {
                setTimeout(() => {
                    toastElement.classList.remove('show'); 
                    setTimeout(() => {
                        const currentToast = document.getElementById('toast-message');
                        if (currentToast === toastElement && !currentToast.classList.contains('show')) {
                            currentToast.innerHTML = ''; 
                            currentToast.classList.remove('error'); 
                        }
                    }, 500); 
                }, 3000); 
            }
        });

        // WebSocket for live button updates
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/button_updates`;
            const socket = new WebSocket(wsUrl);

            socket.onopen = function(event) {
                console.log("WebSocket connection established for live updates.");
            };

            socket.onmessage = function(event) {
                console.log("WebSocket message received:", event.data);
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === "button_content_update" && message.payload) {
                        updateButtonContent(message.payload);
                    }
                } catch (e) {
                    console.error("Error parsing WebSocket message or invalid message format:", e);
                }
            };

            socket.onclose = function(event) {
                console.log("WebSocket connection closed. Attempting to reconnect in 5 seconds...");
                setTimeout(connectWebSocket, 5000); // Simple reconnect logic
            };

            socket.onerror = function(error) {
                console.error("WebSocket error:", error);
                // socket.close() will typically be called by the browser after an error, triggering onclose.
            };
        }

        function updateButtonContent(data) {
            const buttonId = data.button_id;
            if (!buttonId) {
                console.warn("Button update received without button_id:", data);
                return;
            }

            const buttonElement = document.getElementById(`btn-${buttonId}`);
            if (!buttonElement) {
                console.warn(`Button element with id 'btn-${buttonId}' not found for update.`);
                return;
            }

            // Update text
            if (typeof data.text === 'string') {
                const textElement = buttonElement.querySelector('[data-role="button-text"]');
                if (textElement) {
                    textElement.textContent = data.text;
                } else {
                    console.warn(`Text element not found for button 'btn-${buttonId}'.`);
                }
            }

            // Update icon
            const iconElement = buttonElement.querySelector('[data-role="button-icon"]');
            if (iconElement) {
                if (typeof data.icon_class === 'string') {
                    if (data.icon_class) {
                        iconElement.className = data.icon_class;
                        iconElement.style.display = ''; // Ensure it's visible
                    } else { // Empty string or null means remove icon
                        iconElement.className = '';
                        iconElement.style.display = 'none'; // Hide it
                    }
                }
            } else if (typeof data.icon_class === 'string' && data.icon_class) {
                // If icon element doesn't exist but new icon_class is provided, create it
                console.warn(`Icon element not found for button 'btn-${buttonId}', creating one.`);
                const newIcon = document.createElement('i');
                newIcon.setAttribute('data-role', 'button-icon');
                newIcon.className = data.icon_class;
                // Prepend to keep it before the text, similar to the template
                const textSpan = buttonElement.querySelector('[data-role="button-text"]');
                if (textSpan) {
                    buttonElement.insertBefore(newIcon, textSpan);
                } else {
                    buttonElement.prepend(newIcon);
                }
            }


            // Update style class
            if (typeof data.style_class === 'string') {
                const currentStyle = buttonElement.dataset.currentStyleClass;
                if (currentStyle && currentStyle !== "") {
                    buttonElement.classList.remove(currentStyle);
                }
                if (data.style_class && data.style_class !== "") {
                    buttonElement.classList.add(data.style_class);
                    buttonElement.dataset.currentStyleClass = data.style_class;
                } else {
                    buttonElement.dataset.currentStyleClass = ""; // Clear stored style
                }
            }
             // Update title attribute if text changed
            if (typeof data.text === 'string') {
                buttonElement.title = data.text;
            }
        }

        // Initialize WebSocket connection when the page loads
        document.addEventListener('DOMContentLoaded', connectWebSocket);
    </script>
</body>
</html>
