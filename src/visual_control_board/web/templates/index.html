<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title | default("Visual Control Board") }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <!-- FontAwesome for icons (optional, if you use icon_class) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <h1>{{ current_page.name if current_page else page_title | default("Control Board") }}</h1>
    </header>

    <main class="container">
        {% if error %}
            <div class="error-message">{{ error }}</div>
        {% elif current_page and current_page.buttons %}
            <div 
                class="button-grid" 
                {% if current_page.layout == 'grid' and current_page.grid_columns is not none %}
                    style="grid-template-columns: repeat({{ current_page.grid_columns }}, 1fr);"
                {% endif %}
            >
                {% for button in current_page.buttons %}
                    {% include "partials/button.html" with button=button, request=request %}
                {% endfor %}
            </div>
        {% elif current_page %}
             <p>No buttons configured for page: {{ current_page.name }}.</p>
        {% else %}
            <p>No page or buttons configured to display.</p>
            <p>Please ensure <code>ui_config.yaml</code> is correctly placed in <code>src/visual_control_board/user_config/</code> and is properly formatted.</p>
        {% endif %}
    </main>

    <footer>
        <p>Visual Control Board</p>
        <!-- Area for toast messages / feedback -->
        <div id="toast-container">
            <!-- 
                This div will be the target for Out-of-Band swaps of toast messages.
                The toast.html partial defines a div with id="toast-message" and hx-swap-oob="true".
                HTMX will swap the content of an existing #toast-message div if present,
                or effectively insert it if the JS removes the previous one.
                We add an empty div here to ensure the first toast has a target for replacement.
            -->
            <div id="toast-message"></div>
        </div>
    </footer>

    <script>
        // This script handles the auto-hiding of toast messages.
        // For more complex JavaScript, consider moving this to a separate file in static/js/.
        document.body.addEventListener('htmx:afterSwap', function(event) {
            // Check if the swapped content includes our toast structure.
            // The OOB swap targets #toast-container by placing a div with id="toast-message" inside it,
            // or rather, it swaps an existing #toast-message element.
            const toastElement = document.getElementById('toast-message'); 
            
            if (toastElement && toastElement.classList.contains('show') && toastElement.textContent.trim() !== '') {
                // Check textContent to ensure it's not the initial empty placeholder
                setTimeout(() => {
                    toastElement.classList.remove('show');
                    // Optional: remove the element after fade out to keep DOM clean if many toasts appear
                    // and to ensure subsequent toasts with the same ID are correctly handled.
                    // This also means the next toast (which is a div with id="toast-message") will be "newly" inserted.
                    setTimeout(() => {
                        if (toastElement.parentElement) {
                            // Check if it's still the same element before removing,
                            // in case a new toast replaced it quickly.
                            const currentToast = document.getElementById('toast-message');
                            if (currentToast === toastElement) {
                                // Instead of removing, let's clear its content and hide it,
                                // so it remains a target for the next OOB swap.
                                // currentToast.remove(); 
                                currentToast.innerHTML = ''; // Clear content
                                currentToast.classList.remove('toast', 'show', 'error'); // Reset classes
                            }
                        }
                    }, 500); // Match CSS transition duration for fade-out
                }, 3000); // Hide after 3 seconds
            } else if (toastElement && toastElement.textContent.trim() === '' && !toastElement.classList.contains('show')) {
                // This is likely the initial empty placeholder, do nothing or ensure it's hidden.
                // It should not have 'show' class initially.
            }
        });
    </script>
</body>
</html>
